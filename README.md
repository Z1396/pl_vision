# pl_vision
在superpower开源的2025视觉代码上修改为适配我们的代码

## standard_mpc_fd.cpp 使用指南

### 1. 功能概述

`standard_mpc_fd.cpp` 是项目的核心视觉处理文件，实现了基于模型预测控制（MPC）的自动瞄准系统。该文件集成了相机数据采集、目标检测、跟踪、坐标解算、轨迹规划和云台控制等功能，用于实现对敌方机器人装甲板的自动识别和瞄准。

### 2. 核心算法原理

- **目标检测**：支持传统图像处理和YOLO深度学习两种检测方法，可根据配置切换
- **目标跟踪**：使用多目标跟踪算法，结合扩展卡尔曼滤波器（EKF）实现稳定跟踪
- **坐标解算**：通过相机内参、外参和IMU数据，实现相机坐标系到云台坐标系再到世界坐标系的转换
- **轨迹规划**：基于模型预测控制（MPC）算法，根据目标运动状态和子弹速度，预测目标未来位置并生成云台控制指令
- **时间同步**：通过时间戳对齐，解决相机采集与云台控制之间的时间差问题

### 3. 适用场景

- 机器人竞赛中的自动瞄准系统
- 需要实时目标跟踪和精准控制的视觉应用
- 基于CAN总线的控制系统与视觉系统集成

## 4. 编译环境配置

### 4.1 依赖项

- OpenCV 4.5+：图像处理
- Eigen 3.3+：矩阵运算
- nlohmann/json：JSON解析
- fmt：格式化输出
- C++17 或更高版本
- FDCAN总线驱动：用于与FD控制板通信

### 4.2 编译步骤

1. 克隆项目代码
2. 安装依赖项
3. 配置CMakeLists.txt
4. 编译项目

```bash
# 示例编译命令
mkdir build && cd build
cmake ..
make -j4
```

## 5. 参数配置方法

### 5.1 配置文件结构

项目使用YAML格式的配置文件，默认路径为 `configs/standard3.yaml`。配置文件包含以下主要部分：

- **敌方目标颜色设置**：`enemy_color`
- **神经网络参数**：YOLO模型路径、置信度阈值等
- **传统检测参数**：阈值、灯条比例范围等
- **跟踪器参数**：最小检测次数、最大临时丢失计数等
- **瞄准器参数**：偏航角补偿、俯仰角补偿等
- **相机参数**：内参、外参、曝光时间等
- **控制板参数**：CAN ID、接口名称等
- **规划器参数**：开火阈值、最大加速度等

### 5.2 关键参数说明

| 参数 | 含义 | 取值范围 | 调整建议 |
|------|------|----------|----------|
| `enemy_color` | 敌方目标颜色 | "red" 或 "blue" | 根据实际比赛情况选择 |
| `min_confidence` | 检测置信度阈值 | 0.0-1.0 | 建议0.8-0.9，平衡检测率和误检率 |
| `use_traditional` | 是否使用传统检测 | true/false | 光线条件好时建议false，使用YOLO |
| `max_temp_lost_count` | 最大临时丢失计数 | 5-50 | 运动目标建议15-20 |
| `yaw_offset`/`pitch_offset` | 偏航/俯仰角补偿 | -5.0-5.0度 | 根据实际安装误差调整 |
| `low_speed_delay_time` | 低速延迟时间 | 0.05-0.2秒 | 子弹速度慢时增大，快时减小 |
| `max_pitch_acc` | 最大俯仰角加速度 | 5-15 rad/s² | 调大响应快但易抖，调小运动平滑但响应慢 |
| `Q_pitch` | 俯仰角卡尔曼滤波Q矩阵 | 正数数组 | [10.0, 1.0] 为初始建议值 |
| `R_pitch` | 俯仰角卡尔曼滤波R矩阵 | 正数数组 | [0.1] 为初始建议值 |

## 6. 视觉端调试流程

### 6.1 调试环境搭建

1. **硬件准备**：
   - 相机（推荐海康或大华工业相机）
   - 计算机（推荐搭载GPU以加速深度学习推理）
   - 调试显示器

2. **软件准备**：
   - plotjuggler（用于可视化调试数据）

### 6.2 常用调试工具

- **OpenCV窗口**：实时显示检测结果和重投影点
- **日志系统**：输出运行状态和错误信息
- **数据录制器**：录制图像、IMU数据和时间戳，用于赛后分析

### 6.3 视觉数据采集与处理

1. **相机标定**：使用棋盘格进行相机内参标定，确保坐标解算准确性
2. **数据采集**：采集不同距离、角度、光照条件下的目标图像
3. **参数调优**：根据采集的数据调整检测、跟踪和瞄准参数
4. **验证步骤**：
   - 静态目标验证：验证近距离和远距离静态目标的检测和瞄准精度
   - 动态目标验证：验证移动目标的跟踪稳定性和预测准确性

### 6.4 常见视觉问题诊断与解决

| 问题 | 可能原因 | 解决方法 |
|------|----------|----------|
| 目标检测失败 | 光线过暗/过亮 | 调整相机曝光时间和增益 |
| 跟踪不稳定 | 目标运动过快 | 增大最大临时丢失计数 |
| | 检测结果波动大 | 调整卡尔曼滤波参数 |
| 瞄准精度低 | 相机标定不准确 | 重新进行相机标定 |
| | 时间同步误差 | 检查IMU时间戳和相机采集时间戳 |
| | 子弹速度估计不准 | 校准子弹速度测量装置 |

## 7. 与下位机联调指南

### 7.1 通信协议说明

- **通信方式**：FDCAN总线通信
- **FDCAN ID配置**：
  - 四元数CAN ID：`0x100`
  - 子弹速度CAN ID：`0x101`
  - 发送CAN ID：`0xff`
- **CAN接口**：默认 `can0`

### 7.2 数据交互格式

- **从下位机接收**：
  - IMU数据：四元数表示的云台姿态
  - 子弹速度：当前子弹速度
  - 偏航角速度：当前偏航角速度
  - 俯仰角速度：当前俯仰角速度
  - 弹数：当前云台弹数

- **向下位机发送**：
  - 云台控制指令：目标角度、速度、加速度
  - 开火指令：是否开火
    控制指令

### 7.3 联调前准备工作

1. **硬件检查**：
   - 确认FDCAN总线连接正常
   - 确认相机与下位机供电稳定（相机要插3.0usb口）
   - 确认陀螺仪机械结构无松动

2. **软件检查**：
   - 配置文件参数正确设置
   - FDCAN总线驱动正常加载
   - 相机驱动正常工作

3. **安全措施**：
   - 确保云台运动范围内无障碍物
   - 准备紧急停止按钮

### 7.4 联调步骤

1. **单独测试**：
   - 测试相机采集功能
   - 测试FDCAN总线通信
   - 测试云台手动控制

2. **集成测试**：
   - 启动视觉系统
   - 测试目标检测和跟踪
   - 测试自动瞄准功能
   - 测试开火功能

3. **系统测试**：
   - 完整运行整个系统
   - 测试不同场景下的性能
   - 记录系统响应时间和 accuracy

### 7.5 故障排查方法

| 故障 | 可能原因 | 解决方法 |
|------|----------|----------|
| CAN通信失败 | CAN总线连接松动 | 检查CAN总线连接 |
| | CAN ID配置错误 | 检查配置文件中的CAN ID设置 |
| 云台无响应 | 控制指令格式错误 | 检查控制指令生成代码 |
| | 云台电源问题 | 检查云台供电 |
| 瞄准不准 | 相机与云台时间不同步 | 检查时间戳对齐逻辑 |
| | 控制参数不合适 | 调整规划器参数 |

## 8. 使用示例

### 8.1 基本使用

```bash
# 使用默认配置文件运行
./standard_mpc_fd

# 使用指定配置文件运行
./standard_mpc_fd configs/standard3.yaml
```

### 8.2 预期效果

- 实时显示相机采集的图像，标注检测到的装甲板
- 稳定跟踪目标，即使目标短暂遮挡也能保持跟踪
- 自动计算瞄准点，预测目标未来位置
- 通过FDCAN总线发送控制指令，控制云台转向目标
- 当目标在开火阈值内时，自动发送开火指令

## 9. 注意事项与最佳实践

### 9.1 安全注意事项

- **人员安全**：在调试过程中，确保云台运动范围内无人员和障碍物
- **设备安全**：避免云台快速转动时与其他设备碰撞
- **电气安全**：确保FDCAN总线和相机设备的供电稳定，避免短路(碳板导电)

### 9.2 系统调试注意事项

- **参数调优**：根据实际环境和硬件情况调整参数，不同场景可能需要不同的参数配置
- **时间同步**：确保相机采集时间戳与IMU数据时间戳准确对齐，这对瞄准精度至关重要
- **数据备份**：定期备份配置文件和调试数据，以便在出现问题时恢复
- **环境适应性**：在不同光照、距离和背景条件下测试系统性能

### 9.3 最佳实践

- **模块化调试**：先单独调试每个模块（相机采集、目标检测、跟踪、控制），再进行集成测试
- **渐进式调优**：从静态目标开始，逐步过渡到动态目标，从近距离到远距离
- **日志记录**：开启详细日志，便于问题定位和系统性能分析
- **定期校准**：定期对相机和IMU进行校准，确保系统精度
- **性能监控**：监控系统响应时间和资源占用，确保实时性
- **代码管理**：使用版本控制工具管理代码和配置文件变更
- **文档更新**：及时更新系统文档，记录参数调整和问题解决方法

## 10. 代码结构说明

`standard_mpc_fd.cpp` 主要包含以下模块：

- **IO模块**：相机数据采集和控制板通信
- **检测模块**：目标检测（传统方法或YOLO）
- **跟踪模块**：目标跟踪和状态估计
- **解算模块**：坐标转换和重投影
- **规划模块**：轨迹规划和控制指令生成
- **工具模块**：日志、绘图、退出控制等

通过多线程设计，实现了检测跟踪与云台规划的并行执行，提高了系统响应速度和实时性。

## 更新日志

### 2026.2.20
- 添加了`standard_mpc_fd.cpp`的详细使用指南
- 完善了视觉端调试流程说明
- 增加了与下位机联调的完整操作指南
- 补充了参数配置方法和关键参数说明
- 添加了使用示例和最佳实践建议

### 2026.2.15
- 初始版本提交
- 实现了基本的自动瞄准功能
- 集成了FDCAN总线通信模块
